#!/usr/bin/env M2 --script

path = prepend(currentDirectory()|"lib/M2code", path)
debug needsPackage "ADAMModel"
needsPackage "JSON"

helpString = ///usage: transform-model [add/remove] [poly/tt/bool] <json-model-file >output-model
  where the input is taken from stdin:
    json-model-file: a model file which includes transition tables
    OR: an error json file
  and the out is written to stdout:
    output-model: the same model (in json format), 
      with the given type of model added or removed.
    OR an error in json format if:
      original input file is an error (it is passed straaight through)
      or
      you are trying to add in 'bool' format (I don't know how to do that yet)
      or
      you are trying to remove the only transition table information
  BUT: if you give incorrect arguments: then the function just ends with an error message on stderr, 
    and a non-zero return value
  example call:
    ./transform-model add poly <~/Sites/ADAM/sampleJSON/sampleModel.json  >foo.json
  example input file:
  example output:
///

print scriptCommandLine;
if #scriptCommandLine != 3 then (
    stderr << helpString;
    exit(1);
    )
add = scriptCommandLine#1
if not member(add, {"add", "remove"}) then (
    stderr << "first argument needs to be either 'add' or 'remove'" << endl;
    exit(2);
    )
type = scriptCommandLine#2
if type != "poly" and type != "tt" and type != "bool" then (
    stderr << "second argument must be 'poly', 'tt', or 'bool'" << endl;
    exit(3);
    )

--------------------------------

M = parseModel get stdio
M1 = transformModel(add,type,M) -- returns a model or an error json (which is a HashTable)
print prettyPrintJSON M1

end

restart
-- example:
./transform-model add poly <~/Sites/ADAM/exampleJSON/SecondVersion1-Model.json
./transition2polynomials <~/Sites/ADAM/exampleJSON/SecondVersion1-Model.json
./transition2polynomials <~/Sites/ADAM/exampleJSON/SimplestVersion1-Model.json
./transition2polynomials <~/Sites/ADAM/exampleJSON/ThirdVersion1-Model.json
./transition2polynomials <~/Sites/ADAM/exampleJSON/lac-operon-full-Model.json
./transition2polynomials <~/Sites/ADAM/exampleJSON/lac-operon-reduced-Model.json

-- this one fails...! Because it doesn't have transition functions?
-- need check that input is OK
./transition2polynomials <~/Sites/ADAM/sampleJSON/sampleModel2.json 
./transition2polynomials <~/Sites/ADAM/sampleJSON/sampleModel.json 
cat ~/Sites/ADAM/exampleJSON/lac-operon-reduced-Model.json | ./transition2polynomials

restart
path = prepend(currentDirectory()|"lib/M2code", path)
debug needsPackage "ADAMModel"
needsPackage "JSON"
M = parseModel get "~/Sites/ADAM/sampleJSON/sampleModel2.json"
-- CHECK: has transition tables
M1 = addPolynomials M
print prettyPrintJSON M1

-- need the following filters/translators
1. validate: input: Model, output: ModelOrError
  variations: also give what features it should have?
  2 versions, 1 in M2: takes a Model
              1 in shell: takes a text file
2. computePolynomials: Model --> ModelOrError
  2 versions: 1 for Model.  Computes polynomials from either TT ot logical formulae
              1 for text file
3. computeTransitionTables
4. computeLogicalExpressions
